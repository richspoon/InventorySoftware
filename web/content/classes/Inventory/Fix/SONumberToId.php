<?phpclass Inventory_Fix_SONumberToId extends Inventory_InventoryBase{    public $Show_Query                  = false;    // TRUE = show the database queries    public $Run_Fix                     = false;    // TRUE = run the actual database updates            public function  __construct()    {        parent::__construct();                $this->Classname = get_class($this);        $this->ClassInfo = array(            'Created By'    => 'Richard Witherspoon',            'Created Date'  => '2013-03-13',            'Updated By'    => '',            'Updated Date'  => '',            'Filename'      => $this->Classname,            'Version'       => '1.0',            'Description'   => 'Fix bad data -  purchase orders - change from having so_number to inventory_purchase_orders_id.',            'Update Log'    => array(                '2013-03-13_1.0'    => "Module Created",            ),        );            } // -------------- END __construct --------------        public function Execute()    {        /* ===== P-CODE ===========================                ======================================== */                        // ----- GET ALL THE DATABASE RECORDS        $records_so         = $this->GetAllRecords_InventorySalesOrders();        $records_lines      = $this->GetAllRecords_InventorySalesOrderLines();        $records_sent   	= $this->GetAllRecords_InventorySalesOrderSent();                        // ----- CREATE A PO NUMBER ARRAY (LOOKUP ARRAY)        $so_map_arr = array();        foreach ($records_so as $record) {            $so_map_arr[$record['so_number']] = $record['inventory_sales_orders_id'];        }                        $this->EchoVar('so_map_arr', $so_map_arr);        //exit();                                                $passed = true;        # ===== START TRANSACTION ============================================================        $this->SQL->StartTransaction();                                        // ----- FIX THE ORDER_LINES        foreach ($records_lines as $record) {                        $so_lookup                      = $record['so_number'];            $inventory_sales_orders_id   	= $so_map_arr[$so_lookup];                        $db_record = array(                'inventory_sales_orders_id'    => $inventory_sales_orders_id,            );                        // ----- Update the inventory_assembly_build record -----            if ($this->Run_Fix && false) {                $where      = "inventory_sales_order_lines_id='{$record['inventory_sales_order_lines_id']}'";                $result     = $this->UpdateRecordLoc('inventory_sales_order_lines', $db_record, $where);                $passed     = (!$result) ? false : $result;                $this->EchoQuery();            } else {                $this->EchoVar('<br />UPDATE QUERY NOT ACTIVE', '&nbsp;', 'red');                $this->EchoVar('db_record', $db_record);            }                    }                        $this->EchoVar('records_sent', $records_sent);        // ----- FIX THE ORDER_RECEIVED_LINES        foreach ($records_sent as $record) {                        $so_lookup                      = $record['so_number'];            $inventory_sales_orders_id   	= $so_map_arr[$so_lookup];                        $db_record = array(                'inventory_sales_orders_id'    => $inventory_sales_orders_id,            );                        // ----- Update the inventory_assembly_build record -----            if ($this->Run_Fix) {                $where      = "inventory_sales_order_sent_id='{$record['inventory_sales_order_sent_id']}'";                $result     = $this->UpdateRecordLoc('inventory_sales_order_sent', $db_record, $where);                $passed     = (!$result) ? false : $result;                $this->EchoQuery();            } else {                $this->EchoVar('<br />UPDATE QUERY NOT ACTIVE', '&nbsp;', 'red');                $this->EchoVar('db_record', $db_record);            }                    }                        # ===== COMMIT TRANSACTION ============================================================        if ($passed && $this->Run_Fix) {            $this->SQL->TransactionCommit();        }    }          public function GetAllRecords_InventorySalesOrders()    {        $records = $this->SQL->GetArrayAll(array(            'table' => 'inventory_sales_orders',            'keys'  => '*',            'where' => "",        ));        $this->EchoQuery();                return $records;    }        public function GetAllRecords_InventorySalesOrderLines()    {        $records = $this->SQL->GetArrayAll(array(            'table' => 'inventory_sales_order_lines',            'keys'  => '*',            'where' => "(inventory_sales_orders_id='' OR inventory_sales_orders_id=0)", // AND active=1        ));        $this->EchoQuery();                return $records;    }        public function GetAllRecords_InventorySalesOrderSent()    {        $records = $this->SQL->GetArrayAll(array(            'table' => 'inventory_sales_order_sent',            'keys'  => '*',            'where' => "(inventory_sales_orders_id='' OR inventory_sales_orders_id=0)", // AND active=1        ));        $this->EchoQuery();                return $records;    }        }  // -------------- END CLASS --------------
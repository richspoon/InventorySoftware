<?phpclass Inventory_BarcodeSummaryReport extends Inventory_InventoryBase{    public $Show_Query                  = false;        // (FALSE) TRUE = show database queries used in this class        // ===== INPUTS ====================    public $Barcode                     = 0;            // will hold the barcode to generate a report for    public $Date                        = '';           // will hold the date to generate a report for            // ===== OUTPUTS ====================        // ===== GENERAL ====================            public function  __construct()    {        parent::__construct();                $this->Classname = get_class($this);        $this->ClassInfo = array(            'Created By'    => 'Richard Witherspoon',            'Created Date'  => '2013-01-11',            'Updated By'    => 'Richard Witherspoon',            'Updated Date'  => '2013-02-25',            'Filename'      => $this->Classname,            'Version'       => '1.2',            'Description'   => 'Create a summary report of COGS and inventory movements for a given Barcode.',            'Update Log'    => array(                '2013-01-11_1.0'    => 'Module created.',                '2013-02-21_1.1'    => 'Modified GetInventoryMovements() to support new database fields',                '2013-02-25_1.2'    => 'Modified many functions due to database field changes',            ),        );            } // -------------- END __construct --------------        public function Execute()    {        echo $this->GetInventoryInOutPriceReport();    }        public function Pseudocode()    {        # FUNCTION :: Pseudocode for this class.                $output = "        [Description]:        Get all the inventory INs and OUTs and what the price must be for those                        [To Do List]:        GetInventoryInOutPriceReport() - FUNCTION IS NOT FUNCTIONAL         ";                $title      = "$this->Classname :: Pseudocode()";        $content    = $this->PseudocodeFormat($output);        $this->EchoInformation($title, $content, 'blue');    }            public function GetInventoryInOutPriceReport($BARCODE='', $DATE='')    {        # FUNCTION :: Get all the inventory INs and OUTs and what the price must be for those                // ----- INITIALIZE VARIABLES -----        $qty_rolling_sum = 0;                                // ----- GET ALL RECORDS RELATED TO THIS BARCODE -----        $records = $this->GetInventoryMovements();        $have_records = ($records) ? true : false;                if(!$have_records) {            $error = "No records found";            $this->AddError($this->Classname, __FUNCTION__, $error);                        $error = "ERROR :: {$this->Classname} :: GetInventoryInOutPriceReport() :: No records found";            return $error;        }                                // ----- Start the output table -----        $report = "<table border='1' id='jsonTable'>";        $report .= "            <tr>                <th>Inventory Counts ID</th>                <th>Date</th>                <th>QTY In</th>                <th>QTY Out</th>                <th>(qty sum)</th>                <th>Adjustment</th>                <th>Price Each (w/ shipping)</th>                <th>Price Total (w/ shipping)</th>                <th>Price Source Type</th>                <th>Price Source ID</th>                <th>Record Active</th>                <th>Notes</th>            </tr>";                                        // ----- PROCESS THE RECORDS -----        $records = $this->orderBy($records, "date", "ASC");     // sort the records by date        //$this->EchoVar('records', $records);                                foreach ($records as $record) {                        // ----- determine the method the inventory change was made with            $method             = '';            $method             = (isset($record['IN_DATE']))   ? 'purchase_order'  : $method;            $method             = (isset($record['ADJ_DATE']))  ? 'adjustment'      : $method;            $method             = (isset($record['ASSY_DATE'])) ? 'assembly'        : $method;            $method             = (isset($record['OUT_DATE']))  ? 'sales_order'     : $method;                                    switch ($method) {                                case 'purchase_order':                    $method_id              = $record['IN_REF_ID'];                    $method_text            = "purchase order received<br />(PO#: {$record['IN_REF_NUMBER']})";                    $date                   = $record['IN_DATE'];                    $price_total            = $record['IN_PRICE_TOTAL'];                    $price_each             = $record['IN_PRICE_EACH'];                    $price_shipping_total   = $record['IN_PRICE_SHIPPING_TOTAL'];                    $price_shipping_each    = $record['IN_PRICE_SHIPPING_EACH'];                    $active                 = $record['IN_ACTIVE'];                    $notes                  = $record['IN_NOTES'];                break;                                case 'adjustment':                    $method_id              = $record['ADJ_REF_ID'];                    $method_text            = "inventory adjustment";                    $date                   = $record['ADJ_DATE'];                    $price_total            = $record['ADJ_PRICE_TOTAL'];                    $price_each             = $record['ADJ_PRICE_EACH'];                    $price_shipping_total   = $record['ADJ_PRICE_SHIPPING_TOTAL'];                    $price_shipping_each    = $record['ADJ_PRICE_SHIPPING_EACH'];                    $active                 = $record['ADJ_ACTIVE'];                    $notes                  = $record['ADJ_NOTES'];                break;                                case 'assembly':                    $method_id              = $record['ASSY_REF_ID'];                    $method_text            = "assembly build";                    $date                   = $record['ASSY_DATE'];                    $price_total            = $record['ASSY_PRICE_TOTAL'];                    $price_each             = $record['ASSY_PRICE_EACH'];                    $price_shipping_total   = 0;                    $price_shipping_each    = 0;                    $active                 = $record['ASSY_ACTIVE'];                    $notes                  = $record['ASSY_NOTES'];                break;                                case 'sales_order':                    $method_id              = $record['OUT_SO_REF_ID';                    $method_text            = "sales order sent<br />(SO#: {$record['OUT_REF_NUMBER']})";                    $date                   = $record['OUT_DATE'];                    $price_total            = 0;                    $price_each             = 0;                    $price_shipping_total   = 0;                    $price_shipping_each    = 0;                    $active                 = $record['OUT_ACTIVE'];                    $notes                  = $record['OUT_NOTES'];                break;                                default:                    $error = "No method determined";                    $this->AddError($this->Classname, __FUNCTION__, $error);                    $this->DumpErrors();                    exit();                break;                            }                                    // ----- post-process date to remove time (if present)            $date_parts         = explode(" ", $date);            $date               = $date_parts[0];                                    // ----- post-process prices            $quantity               = $record['qty_in'] + $record['qty_out'];            $cost_each_default      = $record['DEFAULT_PRICE_EACH'];                        $price_total            = ($price_total)            ? $price_total              : ($price_each * $quantity);            $price_each             = ($price_each)             ? $price_each               : ($price_total / $quantity);            $price_shipping_total   = ($price_shipping_total)   ? $price_shipping_total     : ($price_shipping_each * $quantity);            $price_shipping_each    = ($price_shipping_each)    ? $price_shipping_each      : ($price_shipping_total / $quantity);                                                            $id                     = $record['inventory_counts_id'];            $adjustment             = ($record['adjustment'] == 1) ? 'y' : '';            $date                   = $date;            $qty_in                 = ($record['qty_in'] > 0) ? $record['qty_in'] : '';            $qty_out                = ($record['qty_out'] > 0) ? $record['qty_out'] : '';            $qty                    = $qty_in + $qty_out;            $qty_rolling_sum        = $qty_rolling_sum + $qty_in - $qty_out;            $qty_rolling_sum_style  = ($qty_rolling_sum < 0) ? "style='background-color:red; color:white;'" : '';                        $price_each             = round($price_each, 3);            $price_total            = round($price_total, 3);                        $price_each             = ($price_each) ? "$" . $price_each : "[$" . ($price_total/$qty) . "]";            $price_total            = ($price_total) ? "$" . $price_total : "[$" . ($price_each*$qty) . "]";                        $price_source_type      = $method_text;            $price_source_id        = $method_id;            $active_text            = ($active == 1) ? 'YES' : 'NO';                                                            if ($record['status_use_assembly_pricing'] == 1) {                $status_assembly_pricing    = true;                $inventory_assemblies_id    = $record['inventory_assemblies_id'];                                                # ==========================================================                # SWITCH THIS TO USE THE COGS_Handler FUNCTIONS                # ==========================================================                $default_price              = $this->CalculateAssemblyValue($inventory_assemblies_id);                $default_price              = "";                                                $price_reference = "                    <div style='font-size:14px; font-weight:bold;'>Default Price: \${$default_price}</div>                    <div style='font-size:10px;'>                        price_reference_source: ASSEMBLY PRICE<br />                    </div>";                                } else {                            $status_assembly_pricing = false;                $default_price      = (isset($record['DEFAULT_PRICE_EACH'])) ? $record['DEFAULT_PRICE_EACH'] : 'ERR :: No default price';                $price_reference = "                    <div style='font-size:14px; font-weight:bold;'>Default Price: \${$default_price}</div>                    <div style='font-size:10px;'>                        price_reference_source: {$record['price_reference_source']}<br />                        price_reference_number: {$record['price_reference_number']}<br />                        price_reference_date: {$record['price_reference_date']}<br />                        price_reference_url: {$record['price_reference_url']}<br />                        price_reference_price: {$record['price_reference_price']}<br />                        price_reference_quantity: {$record['price_reference_quantity']}                    </div>";            }                                                                        if ($active) {                $report .= "                    <tr>                        <td>{$id}</td>                        <td>{$date}</td>                        <td>{$qty_in}</td>                        <td>{$qty_out}</td>                        <td {$qty_rolling_sum_style}>{$qty_rolling_sum}</td>                        <td>{$adjustment}</td>                        <td>{$price_each}</td>                        <td>{$price_total}</td>                        <td>{$price_source_type}</td>                        <td>{$price_source_id}</td>                        <td>{$active_text}</td>                        <td>{$notes}</td>                    </tr>";            } else {                $report .= "                    <tr>                        <td>{$id}</td>                        <td>{$date}</td>                        <td>{$qty_in}</td>                        <td>{$qty_out}</td>                        <td {$qty_rolling_sum_style}>{$qty_rolling_sum}</td>                        <td>{$adjustment}</td>                        <td colspan='5' bgcolor='pink'>ERROR :: No reference for this record. Error will cause inventory levels to be incorrect. Run Database Integrity Check to resolve.</td>                        <td>{$notes}</td>                    </tr>";            }                    } // end record loop                if (!$have_records) {            $report .= "<tr><td colspan='11'>NO RECORDS FOUND</td></tr>";        }                $report .= "</table>";                        $price_reference    = (isset($price_reference)) ? $price_reference : "<div style='font-size:14px; font-weight:bold;'>Default Price: N/A</div>";        $description        = $this->GetInventoryItemDetailsFromBarcode($this->Barcode);        $cogs               = $this->InventoryItemLastCost($this->Barcode);        $inventory_count    = $this->InventoryItemQuantityAvailable($this->Barcode, $this->Date);        $cogs_total         = $this->CalculateInventoryValue($this->Barcode, $this->Date);        $output             = "                             <div style='border:1px solid #000; padding:10px; margin:10px;'>                            <table cellpadding='5'>                            <tr>                                <td valign='top' bgcolor='#ccc'><div style='font-size:14px; font-weight:bold;'>{$description}</div></td>                                <td valign='top'>                                    <div style='font-size:14px; font-weight:bold;'>Single Item COGS: \${$cogs}</div>                                    <br /><br />                                    <div style='font-size:14px; font-weight:bold;'>Total Inventory: {$inventory_count}</div>                                    <br /><br />                                    <div style='font-size:14px; font-weight:bold;'>Total Inventory COGS: {$cogs_total}</div>                                </td>                                <td valign='top'><div>{$price_reference}</div></td>                            </tr>                            </table>                            </div>                            <br />                            {$report}";                return $output;    }            public function GetInventoryMovements($BARCODE='', $DATE='')    {        # FUNCTION :: Get all the inventory INs and OUTs related to a specified barcode                $wheredate = ($this->Date) ? " AND inventory_counts.date <= '{$this->Date}' " : "";                $records = $this->SQL->GetArrayAll(array(            'table' => 'inventory_counts',            'keys'  => "    inventory_counts.*,                             `inventory_purchase_order_received`.`price_total`                               AS IN_PRICE_TOTAL,                            `inventory_purchase_order_received`.`price_shipping_total`                      AS IN_PRICE_SHIPPING_TOTAL,                            `inventory_purchase_order_received`.`date`                                      AS IN_DATE,                            `inventory_purchase_order_received`.`inventory_purchase_order_received_id`      AS IN_REF_ID,                            `inventory_purchase_order_received`.`po_number`                                 AS IN_REF_NUMBER,                            `inventory_purchase_order_received`.`active`                                    AS IN_ACTIVE,                            `inventory_purchase_order_received`.`notes`                                     AS IN_NOTES,                                                        `inventory_adjustments`.`price_total`                                           AS ADJ_PRICE_TOTAL,                            `inventory_adjustments`.`price_shipping_total`                                  AS ADJ_PRICE_SHIPPING_TOTAL,                                                        `inventory_adjustments`.`date`                                                  AS ADJ_DATE,                            `inventory_adjustments`.`inventory_adjustments_id`                              AS ADJ_REF_ID,                            `inventory_adjustments`.`active`                                                AS ADJ_ACTIVE,                            `inventory_adjustments`.`notes`                                                 AS ADJ_NOTES,                                                        `inventory_assembly_build`.`price_total`                                        AS ASSY_PRICE_TOTAL,                            `inventory_assembly_build`.`date`                                               AS ASSY_DATE,                            `inventory_assembly_build`.`inventory_assembly_build_id`                        AS ASSY_REF_ID,                            `inventory_assembly_build`.`active`                                             AS ASSY_ACTIVE,                            `inventory_assembly_build`.`notes`                                              AS ASSY_NOTES,                                                        `inventory_sales_order_sent`.`date`                                             AS OUT_DATE,                            `inventory_sales_order_sent`.`so_number`                                        AS OUT_SO_NUMBER,                            `inventory_sales_order_sent`.`inventory_sales_order_sent_id`                    AS OUT_SO_REF_ID,                            `inventory_sales_order_sent`.`so_number`                                        AS OUT_REF_NUMBER,                            `inventory_sales_order_sent`.`active`                                           AS OUT_ACTIVE,                            `inventory_sales_order_sent`.`notes`                                            AS OUT_NOTES,                                                        `inventory_products`.`part_cost`                                                AS DEFAULT_PRICE_EACH,                            `inventory_products`.`description`                                              AS description,                            `inventory_products`.`retailer_code`                                            AS retailer_code,                            `inventory_products`.`price_reference_source`,                            `inventory_products`.`price_reference_number`,                            `inventory_products`.`price_reference_date`,                            `inventory_products`.`price_reference_url`,                            `inventory_products`.`price_reference_price`,                            `inventory_products`.`price_reference_quantity`,                            `inventory_products`.`status_use_assembly_pricing`,                            `inventory_products`.`inventory_assemblies_id`            ",            'where' => "`inventory_counts`.`barcode`='{$this->Barcode}' {$wheredate} AND                                 (                `inventory_counts`.`active`=1 OR                 `inventory_purchase_order_received`.`active`=1 OR                 `inventory_adjustments`.`active`=1 OR                `inventory_assembly_build`.`active`=1  OR                 `inventory_sales_order_sent`.`active`=1                  ) AND                                 (                `inventory_counts`.`qty_in` > 0 OR                 `inventory_counts`.`qty_out` > 0                 ) AND                                 `inventory_counts`.`active` = 1            ",            'joins' => "                        LEFT JOIN `inventory_purchase_order_received`   ON `inventory_purchase_order_received`.`inventory_purchase_order_received_id`   = `inventory_counts`.`ref_purchase_orders_received_id`                         LEFT JOIN `inventory_adjustments`               ON `inventory_adjustments`.`inventory_adjustments_id`                           = `inventory_counts`.`ref_adjustment_id`                         LEFT JOIN `inventory_assembly_build`            ON `inventory_assembly_build`.`inventory_assembly_build_id`                     = `inventory_counts`.`ref_assembly_build_id`                         LEFT JOIN `inventory_sales_order_sent`          ON `inventory_sales_order_sent`.`inventory_sales_order_sent_id`                 = `inventory_counts`.`ref_sales_order_sent_id`                         LEFT JOIN `inventory_products`                  ON `inventory_products`.`barcode`                                               = `inventory_counts`.`barcode`            ",            'order' => "`inventory_counts`.`date` ASC",        ));        $this->EchoQuery();        //$this->EchoVar('records', $records);                return $records;    }                }  // -------------- END CLASS --------------
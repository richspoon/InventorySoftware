<?phpclass Inventory_InventoryPurchaseOrderPlace extends Inventory_InventoryBase{    public $Show_Query                      = false;    public $Header_Row                      = "Barcode|APDM SKU|Description|QTY|Price (ea)|Price (total)|DEL";    public $Locked                          = false;    public $Inventory_Purchase_Orders_ID    = 0;        public function  __construct()    {        parent::__construct();                $this->Classname = get_class($this);        $this->ClassInfo = array(            'Created By'    => 'Richard Witherspoon',            'Created Date'  => '2012-11-05',            'Updated By'    => 'Richard Witherspoon',            'Updated Date'  => '2013-03-06',            'Filename'      => $this->Classname,            'Version'       => '1.6',            'Description'   => 'Create a purchase order',            'Update Log'    => Array(                '2012-11-30_001'    => "Added vendor information field",                '2012-11-30_002'    => "Added new formatting and ability to calculate prices",                '2013-01-02_001'    => "Added code for editing an existing PO",                '2013-01-03_001'    => "Added code for collapsing divs",                '2013-01-08_001'    => "Modified PostProcess() to clean the dollar sign off of price - otherwise won't save correctly",                '2013-03-06_1.6'    => "Various code restructuring for access control. Switched method of tracking PO to using the database ID and not the PO#",            ),        );                $this->SetParameters(func_get_args());        $this->Inventory_Purchase_Orders_ID          = $this->GetParameter(0);                                $this->Table            = 'inventory_purchase_orders';        $this->Index_Name       = 'inventory_purchase_orders_id';                $this->Default_Where    = '';               // additional search conditions        $this->Default_Sort     = '';      // field for default table sort                $this->Add_Submit_Name  = "{$this->Table}_SUBMIT_ADD";        $this->Edit_Submit_Name = "{$this->Table}_SUBMIT_EDIT";        $this->Flash_Field      = $this->Index_Name;                $this->Field_Titles = array(            "{$this->Table}.inventory_purchase_orders_id"           => 'Inventory Purchase Orders Id',                        "{$this->Table}.po_number"                              => 'PO Number',            "{$this->Table}.vendor"                                 => 'Vendor',            "{$this->Table}.ref_document_url"                       => 'Ref URL',            "{$this->Table}.ref_document_number"                    => 'Ref Number',            "{$this->Table}.date"                                   => 'Date',            "{$this->Table}.cost_shipping"                          => 'Cost (shipping)',            "{$this->Table}.cost_other"                             => 'Cost (other)',                        "{$this->Table}.active AS STATUS"                       => 'Status',                        "{$this->Table}.notes"                                  => 'Notes',            "{$this->Table}.active"                                 => 'Active',            "{$this->Table}.updated"                                => 'Updated',            "{$this->Table}.created"                                => 'Created',                        "(SELECT SUM(`price_total`) AS EST_LINE_ITEM_COST FROM `inventory_purchase_order_lines` WHERE `inventory_purchase_order_lines`.`inventory_purchase_orders_id` = `inventory_purchase_orders`.`inventory_purchase_orders_id` AND `inventory_purchase_order_lines`.active=1) AS EST_LINE_ITEM_COST" => 'Estimated Line Item Cost',                    );                $this->Join_Array = Array(            'inventory_counts'  => "LEFT OUTER JOIN `inventory_purchase_order_lines` ON `inventory_purchase_order_lines`.`inventory_purchase_orders_id` = `inventory_purchase_orders`.`inventory_purchase_orders_id`",        );                $this->Default_Fields   = 'po_number, vendor, date, EST_LINE_ITEM_COST, cost_shipping, cost_other, STATUS';        $this->Unique_Fields    = '';                $this->Default_Values   = array(            'status'    => 'open',            'date'      => date('Y-m-d'),        );                $this->Close_On_Success = true;                                //$this->Edit_Links_Count = '4';        //$this->Use_Selection_Tab    = false;        // false = hide the search tab on the table                    } // -------------- END __construct --------------        public function Execute()    {        # FUNCTION :: Main function called after instantiating this class                $this->JavascriptConfirmDeleteAndOpenWindow();      // Javascript needed for deleting records from table with confirmation                $action = Get('action');        switch ($action) {            case 'add':                // ----- Adding a new record                #$this->Default_Values['barcode'] = $this->Barcode;                $this->AddRecord();            break;                        case 'delete':                // ----- special delete case because a lot of different records need to be modified                $this->DeletePurchaseOrder();            break;                        case 'list':            default:                // ----- display list of all assemblies that can be built                $this->ListTable();            break;        }    }        public function ExecuteAjax()    {        # FUNCTION :: Function handles AJAXy calles to this class                $return     = 0;                            // initialize variable        $QDATA      = GetEncryptQuery('eq');        // decode the encrypted query passed in        $action     = Get('action');                // determine what action we're trying to do                                // ----- output debug variables to screen - this will probably kill the return values - but good for debug        //$_GET['show'] = true;        if (Get('show')) {            echo "<br />QDATA = " . ArrayToStr($QDATA);            echo "<br />action = $action";        }                                switch ($action) {                        case 'autocomplete_inventory_lookup':                                // LOOK UP ALL ACTIVE INVENTORY ITEMS                                // query database for records                $query = Get('term');                $records = $this->SQL->GetArrayAll(array(                    'table' => ' inventory_products',                    'keys'  => 'description, retailer_code, barcode, manufacturer_code, status_retired',                    'where' => "(description LIKE '%{$query}%' OR barcode LIKE '%{$query}%' OR retailer_code LIKE '%{$query}%' OR manufacturer_code LIKE '%{$query}%') AND active=1",                ));                                // for records into array format for JSON                $arr = array();                foreach ($records as $record) {                    $retired = ($record['status_retired'] == 1) ? "[Retired] -" : "";                    $arr[] = array(                        'label'             => "{$record['barcode']} - {$retired} {$record['retailer_code']} - ({$record['manufacturer_code']})",                        'description'       => $record['description'],                        'sku'               => $record['retailer_code'],                        'barcode'           => $record['barcode'],                        'manufacturer_code' => $record['manufacturer_code'],                    );                }                                // convert to JSON format                echo json_encode($arr);     // echo out in JSON form                 $return = '';               // clear return value or it will output and screw up return            break;        }                echo $return;    }        private function JavascriptAutocomplete()    {        $eq = EncryptQuery('class=Inventory_InventoryPurchaseOrderPlace');       // Class the autocomplete should call (ideally this class)                $script = <<<SCRIPT                        // ----- autocomplete -----            var termTemplate = "<span class='ui-autocomplete-term'>%s</span>";                        $('#FORM_temp_0').autocomplete({                                 source          : 'http://webmanager.whhub.com/office/AJAX/class_execute.php;eq=$eq;action=autocomplete_inventory_lookup',                minChars        : 0,        // how many characters tot ype before starting function call                selectFirst     : true,     // allows tab to select the top option in returned values                autoFocus       : true,                                // where do we stick the returned results                select: function( event, ui ) {                    $( "#FORM_temp_0" ).val( ui.item.label );                    $( "#FORM_temp_1" ).val( ui.item.barcode );                 // store Barcode                    $( "#FORM_temp_2" ).val( ui.item.sku );                     // store APDM SKU                    $( "#FORM_temp_4" ).val( ui.item.description + '<br /><b>' + ui.item.manufacturer_code + '</b>');             // store Description                    $( "#FORM_temp_8" ).val( ui.item.manufacturer_code );       // store Manufacturer Code                         return false;                },                                // format the matched text in search terms                // NOTE/BUG :: Currently case sensitive so doesn't highlight non-case-matching results                open: function(e,ui) {                    var                        acData = $(this).data('autocomplete'),                        styledTerm = termTemplate.replace('%s', acData.term);                    acData                        .menu                        .element                        .find('a')                        .each(function() {                            var me = $(this);                            me.html( me.text().replace(acData.term, styledTerm) );                        });                }            })                        // format the display of the data in the autocomplete (should probably be a custom function on this class)            // (everything else should be in the base class)            .data( "autocomplete" )._renderItem = function( ul, item ) {                return $( "<li>" )                    .data( "item.autocomplete", item )                    .append( "<a>" + item.label + " <br>" + item.description + "</a>" )                    .appendTo( ul );            };            SCRIPT;        AddScriptOnReady($script);    }        private function JavascriptCreateTable()    {        $this->ScriptJSONTableGeneric();                                // Add in the generic code held in the BaseClass        $this->ScriptCalculatePrice();                                  // Javascript for autocompleting price textboxes                $script = <<<SCRIPT                    // ===== USER DEFINED VARIABLES =====            var targetTextID        = "FORM_autotable_holder";          // defines hidden textarea that will hold the text array            var targetTableDivID    = "autotable_table_display";        // defines the div that wraps the created table            var requiredFieldArray  = ["FORM_temp_1","FORM_temp_5"];            var headerText          = "Barcode|APDM SKU|Description|QTY|Price (ea)|Price (total)|DEL";                        var fieldQty            = "FORM_temp_5";                    // In form - field holding quantity -- defined here for function ScriptCalculatePrice()            var priceEach           = "FORM_temp_6";                    // In form - field for price each -- defined here for function ScriptCalculatePrice()            var priceTotal          = "FORM_temp_7";                    // In form - field for price total -- defined here for function ScriptCalculatePrice()                                    function formTableRow() {                var delimiter       = "|";                var barcode         = $("#FORM_temp_1").val();                var sku             = $("#FORM_temp_2").val();                var description     = $("#FORM_temp_4").val();                var qty             = $("#FORM_temp_5").val();                var priceEach       = $("#FORM_temp_6").val();                var priceTotal      = $("#FORM_temp_7").val();                                // ----- create the string that will be added to table.                // ----- no starting or ending delimiter                // ----- action buttons will be added by other function                var output = barcode + delimiter + sku + delimiter + description + delimiter + qty + delimiter + priceEach + delimiter + priceTotal;                return output;            }                        function clearDataTextboxes() {                // -- clear the textboxes used to search on table data                $("#FORM_temp_0").val('');                $("#FORM_temp_1").val('');                $("#FORM_temp_2").val('');                $("#FORM_temp_4").val('');                $("#FORM_temp_5").val('');                $("#FORM_temp_6").val('');                $("#FORM_temp_7").val('');                $("#FORM_temp_8").val('');                            }SCRIPT;        AddScript($script);                $script = <<<SCRIPT            // -- call table creation function on load            // -- rebuilds table after coming back from form errors            var targetText          = $("#" + targetTextID);      // defines hidden textarea that will hold the text array            var targetTableDiv      = $("#" + targetTableDivID);    // defines the div that wraps the created table            createTableFromTextbox(targetText, targetTableDiv);SCRIPT;        AddScriptOnReady($script);    }        public function GetLockedStatus($ID)    {        // ----- determine if purchase order should be locked        $records = $this->SQL->GetArrayAll(array(            'table'     => "inventory_purchase_order_received",            'keys'      => "*",            'where'     => "`inventory_purchase_orders_id`='{$ID}' AND active=1",        ));        $this->EchoQuery();                $locked = ($records) ? true : false;                return $locked;    }        public function GetExistingRecords($ID)    {        // ----- get all records from the database        //$po_number = $this->GetSalesOrderNumberFromID($this->Edit_Id);        $records = $this->SQL->GetArrayAll(array(            'table'     => "inventory_purchase_order_lines",            'keys'      => "inventory_purchase_order_lines.*, inventory_products.description, inventory_products.retailer_code",            'where'     => "`inventory_purchase_orders_id`='{$ID}' and `inventory_purchase_order_lines`.`active`=1",            'joins'     => "LEFT JOIN `inventory_products` ON `inventory_products`.`barcode` = `inventory_purchase_order_lines`.`barcode`",        ));        $this->EchoQuery();                // ----- format records for output        $count = 1;        $table = $this->Header_Row . "\n";        foreach ($records as $record) {            $del            = ($this->Locked) ? "LOCKED" : "<div class='button_delete' id='row_1' onclick='tableDeleteRow(\" row_{$count} \")'>X</div>";            $price_total    = money_format("%n", $record['price_total']);            $price_each     = money_format("%n", ($record['price_total'] / $record['quantity']));                        $table .= "{$record['barcode']}|{$record['retailer_code']}|{$record['description']}|{$record['quantity']}|{$price_each}|{$price_total}|{$del}\n";            $count++;        }                                // ----- put formatted records into POST array and add javascript to add extra needed line break        $_POST['FORM_autotable_holder'] = $table;        AddScriptOnReady('$("#FORM_autotable_holder").val($("#FORM_autotable_holder").val() + "\n");');    }        public function SetFormArrays()    {        # FUNCTION :: Output the main user form to the screen                        // ----- if editing record - need to get the records from database and put on the page        if (($this->Action == 'EDIT') && (!havesubmit($this->Add_Submit_Name)) && (!havesubmit($this->Edit_Submit_Name))) {                        $this->Inventory_Purchase_Orders_ID     = $this->Edit_Id;            $po_number                              = $this->GetPurchaseOrderNumberFromID($this->Inventory_Purchase_Orders_ID);            $this->Locked                           = $this->GetLockedStatus($this->Inventory_Purchase_Orders_ID);            $this->GetExistingRecords($this->Inventory_Purchase_Orders_ID);                        if ($this->Locked) {                AddScriptOnReady("$('#FORM_po_number').val('{$po_number}');");                AddScriptOnReady("$('#temp_ponumber').html('{$po_number}');");                AddScriptOnReady("$('#FORM_temp_locked').val(1);");            }        }                                // ----- Javascript Functionality -----        $this->JavascriptDisplaySessionMessage();   // Display alert messages        $this->JavascriptAutocomplete();            // Javascript for autocomplete functionality        $this->JavascriptCreateTable();             // Javascript for creating table from array of data        $this->JavascriptToggleFunctionality();     // Javascript for toggling div areas                $this->JavascriptDatepickerFunctionality(array('FORM_date'));        $this->JavascriptDisableFunctionality(array('FORM_temp_1','FORM_temp_2','FORM_temp_4','FORM_temp_8'));      // don't allow user to change values on these fields        $this->JavascriptInputNoBorder(array('FORM_temp_1','FORM_temp_2','FORM_temp_4','FORM_temp_8'));             // don't show form border on these fields                                $btn_add        = MakeButton('positive', 'ADD', '', '', 'btn_add', "addDataToTable()", 'button', 'btn_add');        $btn_clear      = MakeButton('negative', 'CLEAR', '', '', 'btn_clear', "clearDataTextboxes()", 'button', 'btn_clear');        $R              = 'N';                        $CLASS_EXECUTE_LINK     = '/office/class_execute';        $eq_receive             = EncryptQuery("class=Inventory_InventoryProducts;v1=;");        $link_receive           = $CLASS_EXECUTE_LINK . '?eq=' . $eq_receive . '&action=add';        $script_receive         = "top.parent.appformCreate('Window', '{$link_receive}', 'apps'); return false;"; //top.        $btn_add_inventory      = ''; //MakeButton('positive', 'ADD INVENTORY ITEM', '', '', 'btn_add_inventory', "{$script_receive}", 'button', 'btn_add_inventory');                                // ----- create list of all previously entered vendors        $vendors        = $this->SQL->GetFieldValues($this->Table, 'vendor', "vendor != ''");        $vendor_list    = Form_ArrayToList($vendors);                        if (!$this->Locked) {                        $base_array = array(                "form|$this->Action_Link|post|db_edit_form",                                'hidden|inventory_purchase_orders_id',                'hidden|temp_locked',                                "code|<div class='shadow form_section_wrapper'>",                    'code|<div class="form_section_header">PURCHASE ORDER INFORMATION</div>',                    'text|PO Number|po_number|Y|60|255',                    'text|Date|date|N|20|255',                    "selecttext|Vendor|vendor|N|40|80||$vendor_list",                    'text|Estimated Shipping Cost|cost_shipping|N|20|255',                    'text|Estimated Other Cost|cost_other|N|20|255',                    'textarea|Notes|notes|N|60|2',                'code|</div>',                'code|<br /><br />',                                                "code|<div class='shadow form_section_wrapper'>",                                        "text|Search|temp_0|$R|60|100",                    "text|Barcode|temp_1|$R|60|100",                    "text|APDM SKU|temp_2|$R|60|100",                    "text|Manufacturer SKU|temp_8|$R|60|100",                    "text|Description|temp_4|$R|60|100",                                        "titletemplate|{$this->title_template}",                    "infotemplate|{$this->info_template}",                                        "code|<div style='padding-left:120px;'><table><tr>",                    "code|<td>",                        "text|QTY|temp_5|$R|10|100",                    "code|</td>",                    "code|<td>",                        "text|Price (ea)|temp_6|$R|10|100",                    "code|</td>",                    "code|<td>",                        "text|Price (total)|temp_7|$R|10|100",                    "code|</td>",                    "code|</tr></table></div>",                                        "titletemplate|STD",                    "infotemplate|STD",                                        "info||$btn_add      &nbsp;&nbsp;&nbsp;    $btn_clear     &nbsp;&nbsp;&nbsp;     $btn_add_inventory",                                    "code|</div>",                'code|<br /><br />',                                                "code|<div id='autotable_table_display'></div>",                'code|<br /><br />',                                                "code|<div class='shadow form_section_wrapper'>",                    'code|<div class="form_section_header">REFERENCE INFORMATION <a class="toggle" href="#" id="menu_group_a"><span class="updown">&nbsp;</span></a></div>',                    'code|<div class="menu_group" style="display:none;" id="div_menu_group_a">',                        'text|Ref. Document|ref_document_number|N|60|1024',                        'text|Ref. Document URL|ref_document_url|N|60|255',                    'code|</div>',                'code|</div>',                                'code|<div style="display:none;">',                'textarea|Temp 3|autotable_holder|N|60|4',                'code|</div>',            );                } else {                        // Note :: Any field in this section must also be HIDDEN in the above section or it won't process on form submission                        $base_array = array(                "form|$this->Action_Link|post|db_edit_form",                                #'text|ID|inventory_purchase_orders_id|N|20|255',                'hidden|inventory_purchase_orders_id',                'hidden|temp_locked',                                                "code|<div class='shadow form_section_wrapper_error'>",                    "code|PURCHASE ORDER IS LOCKED BECAUSE INVENTORY HAS ALREADY BEEN RECEIVED. TO MAKE MODIFICATION YOU MUST DELETE THE PURCHASE ORDER - WHICH WILL UN-RECEIVE ALL ITEMS.",                "code|</div>",                'code|<br /><br />',                                                "code|<div class='shadow form_section_wrapper'>",                    'code|<div class="form_section_header">PURCHASE ORDER INFORMATION</div>',                    'text|PO Number|po_number|N|20|255',                    'text|Date|date|N|20|255',                    "selecttext|Vendor|vendor|N|40|80||$vendor_list",                    'text|Estimated Shipping Cost|cost_shipping|N|20|255',                    'text|Estimated Other Cost|cost_other|N|20|255',                    'textarea|Notes|notes|N|60|2',                'code|</div>',                'code|<br /><br />',                                                "code|<div class='shadow form_section_wrapper'>",                    'code|<div class="form_section_header">REFERENCE INFORMATION <a class="toggle" href="#" id="menu_group_a"><span class="updown">&nbsp;</span></a></div>',                    'code|<div class="menu_group" style="display:none;" id="div_menu_group_a">',                        'text|Ref. Document|ref_document_number|N|60|1024',                        'text|Ref. Document URL|ref_document_url|N|60|255',                    'code|</div>',                'code|</div>',                'code|<br /><br />',                                                "code|<div id='autotable_table_display'></div>",                'code|<br /><br />',                                                'code|<div style="display:none;">',                    'text|Search|temp_0|N|60|100',                    'textarea|Temp 3|autotable_holder|N|60|4',                'code|</div>',            );                }                if ($this->Action == 'ADD') {            $base_array[] = "submit|Add Record|$this->Add_Submit_Name";            $base_array[] = 'endform';            $this->Form_Data_Array_Add = $base_array;        } else {            //$base_array[] = 'checkbox|Active|active||1|0';            $base_array[] = "submit|Update Record|$this->Edit_Submit_Name";            $base_array[] = 'endform';            $this->Form_Data_Array_Edit = $base_array;        }    }        public function PostProcessFormValues($FormArray)     {                /* ======================== PSEUDOCODE ========================                Check each inventory item to make sure they still exist (superfulous but do it)        Verify the PO number is unique        For each line set the purchase line TOTAL (derived from qty and each price)                Start Transaction        Create the Purchase Order entry        Create each Purchase Order LINE entry        End Transaction                Clear out the entire array        Put a success message on the screen        Re-direct to the entry page                Note: This bypasses normal action of BaseClass doing the entry into database - but this is needed        because its a multi-table entry                =============================================================== */                $delimiter                      = '|';        $table_holder                   = 'autotable_holder';        $field_kickout_string           = 'temp_';        $lines_array                    = array();                                      // will hold lines        $passed                         = true;                                         // holds check-passed status        $adding                         = ($this->Action == 'ADD') ? true : false;      // hold edit status        $locked                         = (isset($FormArray['temp_locked']) && ($FormArray['temp_locked'] == 1)) ? true : false;        $inventory_purchase_orders_id   = $FormArray['inventory_purchase_orders_id'];                if (false) {            $this->EchoVar('FormArray', $FormArray);            $this->EchoVar('Action', $this->Action);            $this->EchoVar('adding', $adding);            $this->EchoVar('locked', $locked);            $this->EchoVar('inventory_purchase_orders_id', $inventory_purchase_orders_id);            #exit();        }                // ----- if locked - the only thing we can do is modify the form        if ($locked) {            # ----- Create the Purchase Order entry            $db_record = array(                'po_number'             => $FormArray['po_number'],                'vendor'                => $FormArray['vendor'],                'ref_document_url'      => $FormArray['ref_document_url'],                'ref_document_number'   => $FormArray['ref_document_number'],                'date'                  => $FormArray['date'],                'cost_shipping'         => $FormArray['cost_shipping'],                'cost_other'            => $FormArray['cost_other'],                'notes'                 => $FormArray['notes'],                );            $where      = "`inventory_purchase_orders_id`='{$inventory_purchase_orders_id}' AND `active`=1";            $result     = $this->UpdateRecordLoc('inventory_purchase_orders', $db_record, $where);            $this->EchoQuery(true);                        if ($result) {                // ----- Do A force redirect to bypass BaseClass further procesing this                $link = $this->getPageURL();                $_SESSION['alert_message'] = "PURCHASE ORDER UPDATED SUCESSFULLY";                header("Location: {$link}");            } else {                echo "ERROR :: Unable to update sales order.";                exit();            }        }                                // ----- remove any temp fields from the array so they don't get processed        // ----- NOTE :: WASTED STEP IF WE BLOW OUT ARRAY AT END OF FUNCTION        foreach ($FormArray as $field => $value) {            //echo "{$field} => {$value} <br />";            $pos = strpos($field, $field_kickout_string);            if ($pos !== false) {                unset($FormArray[$field]);    //remove the field            }        }                                // ----- check for unique PO #        if ($adding) {            $unique = $this->SQL->IsUnique('inventory_purchase_orders', 'po_number', $FormArray['po_number'], 'active=1');            if (!$unique) {                $this->Error .= "<br />ERROR :: Purchase Order number is not unique. PO Number: {$FormArray['po_number']}";                $passed = false;            }        }                                // ----- get the main table holder value to process        $table = $FormArray[$table_holder];        if ($table) {            $lines          = explode("\n", $table);            $header_row     = true;                        foreach ($lines as $key => $line) {                if ($line) {                    if ($header_row == false) {                        $parts          = explode($delimiter, $line);                        $barcode        = trim($parts[0]);                        $sku            = trim($parts[1]);                        $description    = trim($parts[2]);                        $quantity       = trim($parts[3]);                        $price_each     = $this->CleanMoney(trim($parts[4]));                        $price_total    = $this->CleanMoney(trim($parts[5]));                        $price          = ($price_total != '') ? $price_total : ($quantity * $price_each);                                                                        // ----- check that inventory still exists                        $row = $this->SQL->GetRecord(array(                            'table' => 'inventory_products',                            'keys'  => 'barcode',                            'where' => "barcode = '{$barcode}' AND active=1",                        ));                                                if (empty($row)) {                            $this->Error .= "<br />ERROR :: Inventory item does not exist. Barcode: {$barcode}";                            $passed = false;                        } else {                            $lines_array[] = array(                                'po_number'                     => $FormArray['po_number'],                                'barcode'                       => $barcode,                                'quantity'                      => $quantity,                                'price_total'                   => $price,                            );                        }                    } else {                        // have to set header to false here or it could trigger on blank first line                        $header_row     = false;                    }                } //end blank line check                            }        } //end empty table check                                //$this->Error .= "<br />PURPOSFUL HALTING ERROR";                                                // ----- verify if any good lines made it to processing - we don't want to allow a 0-line PO        if (!$lines_array) {            $this->Error .= "THIS PURCHASE ORDER HAS NO VALID LINES TO PROCESS";        }                        // ----- if all checks have passed and this isn't a blank invoice after processing        if ($passed && $lines_array) {                        # ===== START TRANSACTION ============================================================            $this->SQL->StartTransaction();                        # ----- Create the Purchase Order entry            $db_record = array(                'po_number'             => $FormArray['po_number'],                'vendor'                => $FormArray['vendor'],                'ref_document_url'      => $FormArray['ref_document_url'],                'ref_document_number'   => $FormArray['ref_document_number'],                'date'                  => $FormArray['date'],                'cost_shipping'         => $FormArray['cost_shipping'],                'cost_other'            => $FormArray['cost_other'],                'notes'                 => $FormArray['notes'],            );                            if ($adding) {                $result                         = $this->AddRecordLoc('inventory_purchase_orders', $db_record);                $inventory_purchase_orders_id   = $this->SQL->Last_Insert_Id;                $passed                         = (!$result) ? false : $passed;                $this->EchoQuery();            } else {                $where      = "`inventory_purchase_orders_id`='{$inventory_purchase_orders_id}' AND `active`=1";                $result     = $this->UpdateRecordLoc('inventory_purchase_orders', $db_record, $where);                $passed     = (!$result) ? false : $passed;                $this->EchoQuery();            }                                                # ----- Delete old Purchase Order LINES entry            // ---- currently this is the fastest way to deal with editing lines - because we don't need            //      to track the IDs in the on-screen table. Just deactivate lines and let them be added again.            if (!$adding) {                $db_record = array(                    'active'            => 0,                );                $where      = "`inventory_purchase_orders_id`='{$inventory_purchase_orders_id}' AND `active`=1";                $result     = $this->UpdateRecordLoc('inventory_purchase_order_lines', $db_record, $where);                $passed     = (!$result) ? false : $passed;                $this->EchoQuery();            }                                                # ----- Create the Purchase Order LINES entry            foreach ($lines_array as $line) {                $db_record = array(                    'inventory_purchase_orders_id'  => $inventory_purchase_orders_id,       // tie this to the correct PO record                    'barcode'                       => $line['barcode'],                    'quantity'                      => $line['quantity'],                    'price_total'                   => $line['price_total'],                );                $result     = $this->AddRecordLoc('inventory_purchase_order_lines', $db_record);                $passed     = (!$result) ? false : $passed;                $this->EchoQuery();            }                        # ===== COMMIT TRANSACTION ============================================================            if ($passed) {                $this->SQL->TransactionCommit();                                // ----- Do A force redirect to bypass BaseClass further procesing this                $link = $this->getPageURL();                $_SESSION['alert_message'] = ($adding) ? "RECORD ADDED SUCESSFULLY" : "RECORD UPDATED SUCESSFULLY";                header("Location: {$link}");            }                } else {            // ----- return form array to process any legitimate errors            return $FormArray;        }                    }        public function DeletePurchaseOrder()    {        /* ===== P-CODE =================                * -- Don't allow if inventory has been received - force person to un-receive inventory first                1. Delete the master record        2. Delete all the PO lines                ============================== */                if ($this->Inventory_Purchase_Orders_ID) {                        $passed         = true; // initialize variable            $status         = $this->StatusPurchaseOrder(0, $this->Inventory_Purchase_Orders_ID);                        if ($status != 'open') {                echo "Purchase order has recevied inventory - unreceive and try again.";                exit();            }                                    # ===== START TRANSACTION ============================================================            $this->SQL->StartTransaction();                        // ----- de-activate the main record            $db_record  = array('active' => 0);            $where      = "`inventory_purchase_orders_id`='{$this->Inventory_Purchase_Orders_ID}'";            $result     = $this->UpdateRecordLoc('inventory_purchase_orders', $db_record, $where);            $passed     = (!$result) ? false : $passed;            $this->EchoQuery();                        // ----- de-activate the sub-line records            $db_record  = array('active' => 0);            $where      = "`inventory_purchase_orders_id`='{$this->Inventory_Purchase_Orders_ID}'";            $result     = $this->UpdateRecordLoc('inventory_purchase_order_lines', $db_record, $where);            $passed     = (!$result) ? false : $passed;            $this->EchoQuery();                        # ===== COMMIT TRANSACTION ============================================================            if ($passed) {                $this->SQL->TransactionCommit();                echo "<br /><br /><h2>SUCCESSFULLY DELETED - REFRESH PARENT TABLE</h2>";            }                    } else {            echo "NO Inventory_Purchase_Orders_ID passed in.";        }    }    public function ProcessTableCell($field, &$value, &$td_options, $id='')    {        # ============ WHEN VIEWING A TABLE ============                parent::ProcessTableCell($field, $value, $td_options, $id);        switch ($field) {            default:                // ----- MODIFY THE OPTIONS IN THE MAIN TABLE DISPLAY -----                $CLASS_EXECUTE_LINK     = '/office/class_execute';                                $eq_receive             = EncryptQuery("class=Inventory_InventoryPurchaseOrderReceive;v1={$id};");                $link_receive           = $CLASS_EXECUTE_LINK . '?eq=' . $eq_receive;                $script_receive         = "top.parent.appformCreate('Window', '{$link_receive}', 'apps'); return false;";                                $eq_delete              = EncryptQuery("class=Inventory_InventoryPurchaseOrderPlace;v1={$id};PARENT_DIALOGID=$this->Dialogid_Id");                $link_delete            = $CLASS_EXECUTE_LINK . '?eq=' . $eq_delete . '&action=delete';                $script_delete          = "ConfirmDeleteAndOpenWindow('{$link_delete}'); return false;";                                                // ----- determine which options to show to user                $col_view       = ($this->Flags['view'] == 'false')   ? ''    : "<a href=`#` class=`row_view`       title=`View`            onclick=`tableViewClick('@IDX@','@VALUE@','@EQ@', '@TITLE@'); return false;`></a>";                $col_edit       = ($this->Flags['edit'] == 'false')   ? ''    : "<a href=`#` class=`row_edit`       title=`Edit`            onclick=`tableEditClick('@IDX@','@VALUE@','@EQ@', '@TITLE@'); return false;`></a>";                $col_delete     = ($this->Flags['delete'] == 'false') ? ''    : "<a href=`#` class=`row_delete`     title=`Delete`          onclick=`{$script_delete}`></a>";                $col_receive    = ($this->Flags['print'] == 'false')  ? ''    : "<a href=`#` class=`row_receive`    title=`Receive Inventory`  onclick=`{$script_receive}; return false;`></a>";                                // ----- output the options                $this->Edit_Links_Count = '3';                $this->Edit_Links = qqn("                    <td align=`center`>{$col_edit}</td>                    <td align=`center`>{$col_delete}</td>                    <td align=`center`>{$col_receive}</td>                    ");                                        //<td align=`center`><a href=`#` class=`row_viewline` title=`View Lines`  onclick=`{$script2}; return false;`></a></td>            break;                        case 'date':                $value = date("F jS, Y", mktime("$value"));            break;                        case 'cost_shipping':            case 'cost_other':            case 'EST_LINE_ITEM_COST':                $value = money_format('%n', $value);            break;                        case 'STATUS':                $value = $this->StatusPurchaseOrder(0, $id);                switch ($value) {                    case 'open':                        $td_options = "style=\"background-color:#b2ffb2;\"";                    break;                    case 'partial':                        $td_options = "style=\"background-color:#ffff80;\"";                    break;                    case 'closed':                        $td_options = "style=\"background-color:#ffcccc;\"";                    break;                }                               break;        }    }    }  // -------------- END CLASS --------------
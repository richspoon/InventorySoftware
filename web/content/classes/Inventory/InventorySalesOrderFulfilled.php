<?phpclass Inventory_InventorySalesOrderFulfilled extends Inventory_InventoryBase{    public $Show_Query                      = false;            // (false) TRUE = display database queries    public $Inventory_Sales_Orders_Id       = 0;            public function  __construct()    {        parent::__construct();        $this->SetSQLInventory();   // set the database connection to the inventory database        		$this->Classname = get_class($this);        $this->ClassInfo = array(            'Created By'    => 'Richard Witherspoon',            'Created Date'  => '2012-11-12',            'Updated By'    => 'Richard Witherspoon',            'Updated Date'  => '2013-03-13',            'Filename'      => $this->Classname,            'Version'       => '1.2',            'Description'   => 'Show what lines have alrady been fulfilled on a SO',            'Update Log'    => array(                '2012-12-02_1.1'    => "Fixed bug with deleting sent inventory - transactions enabled in AJAX database stuff.",				'2013-03-13_1.2'	=> "Modified to support database change - track by id not SO#",            ),        );                $this->SetParameters(func_get_args());        $this->Inventory_Sales_Orders_Id         = $this->GetParameter(0);                        $this->Table                = 'inventory_sales_order_sent';        $this->Index_Name           = 'inventory_sales_order_sent_id';                $this->Default_Where        = "`inventory_sales_orders_id`='{$this->Inventory_Sales_Orders_Id}' AND inventory_sales_order_sent.active=1";        $this->Default_Sort         = 'date';      // field for default table sort                $this->Add_Submit_Name      = "{$this->Table}_SUBMIT_ADD";        $this->Edit_Submit_Name     = "{$this->Table}_SUBMIT_EDIT";        $this->Flash_Field          = $this->Index_Name;                $this->Field_Titles = array(            "{$this->Table}.inventory_sales_orders_id"              => 'SOID',            "{$this->Table}.inventory_sales_order_sent_id"          => 'SENT ID',            "{$this->Table}.inventory_sales_order_lines_id"         => 'SO Line ID',            //"{$this->Table}.so_number"                              => 'SO Number',            "{$this->Table}.date"                                   => 'Date',            "{$this->Table}.quantity"                               => 'Quantity',            //"{$this->Table}.price_shipping"                         => 'Shipping Price',            "{$this->Table}.price_total"                            => 'Total Price',            "{$this->Table}.barcode"                                => 'Barcode',            "inventory_products.description"                        => 'Description',            //"inventory_products.manufacturer_code"                  => 'Manufacturer SKU',            "inventory_products.retailer_code"                      => 'APDM SKU',            "{$this->Table}.notes"                                  => 'Notes',            "{$this->Table}.active"                                 => 'Active',            "{$this->Table}.updated"                                => 'Updated',            "{$this->Table}.created"                                => 'Created',        );                        $this->Join_Array = Array(            'inventory_products'  => "LEFT JOIN `inventory_products` ON `inventory_products`.`barcode` = `inventory_sales_order_sent`.`barcode`",        );                        $this->Default_Fields   = 'inventory_sales_orders_id, inventory_sales_order_lines_id, inventory_sales_order_sent_id, date, barcode, description, retailer_code, quantity, price_total';        $this->Unique_Fields    = '';        $this->Default_Values   = array();        $this->Close_On_Success = true;                $this->Edit_Links_Count     = '1';          // number of links at end of table        $this->Add_Link             = '';           // don't allow adding a record        $this->Show_Export          = false;        // false = don't allow export of this table        $this->Default_List_Size    = 1000;         // how many lines to allow in table before pagination        $this->Use_Selection_Tab    = false;        // false = hide the search tab on the table                    } // -------------- END __construct --------------        public function Execute()    {        # FUNCTION :: Main function called after instantiating this class                $this->JavascriptConfirmDeleteAndOpenWindow();      // Javascript needed for deleting records from table with confirmation                $action = Get('action');        switch ($action) {                        case 'list':            default:                // ----- display list of all assemblies that can be built                $output = $this->ListTableText();            break;        }                return $output;    }        public function ExecuteAjax()    {        # FUNCTION :: Function handles AJAXy calles to this class                $return     = 0;                            // initialize variable        $QDATA      = GetEncryptQuery('eq');        // decode the encrypted query passed in        $action     = Get('action');                // determine what action we're trying to do                                // ----- output debug variables to screen - this will probably kill the return values - but good for debug        //$_GET['show'] = true;        if (Get('show')) {            echo "<br />QDATA = " . ArrayToStr($QDATA);            echo "<br />action = $action";        }                                switch ($action) {                        case 'delete_sent_inventory':                                /* P-CODE =================================================                Start Transaction                Deactivate the 'inventory_sales_order_sent' line                Remove the inventory from 'inventory_counts'                Update 'inventory_sales_order_lines' to 'partial' or 'open'                Update 'inventory_sales_orders' to 'partial' or 'open'                End Transaction                ================================================= */                                $this->Show_Query = false;                $passed = true;                                $inventory_sales_order_sent_id = Get('id'); //0;                                if ($inventory_sales_order_sent_id != 0) {                                        # ===== START TRANSACTION ============================================================                    $this->SQL->StartTransaction();                                        # ----- Deactivate the 'inventory_sales_order_sent' line -----                    $db_record = array(                        'active'    => 0,                        'notes'     => 'Inventory previously sent deleted by user',                    );                    $result = $this->SQL->UpdateRecord(array(                        'table'         => 'inventory_sales_order_sent',                        'key_values'    => $this->SQL->KeyValues($db_record),                        'where'         => "`inventory_sales_order_sent_id`='{$inventory_sales_order_sent_id}'",                    ));                    $passed = (!$result) ? false : $passed;                    $this->SQL->EchoQuery($this->Classname, __FUNCTION__);                                                            # ----- Remove the inventory from 'inventory_counts' -----                    $db_record = array(                        'active'    => 0,                        'notes'     => 'Inventory previously sent deleted by user',                    );                    $result = $this->SQL->UpdateRecord(array(                        'table'         => 'inventory_counts',                        'key_values'    => $this->SQL->KeyValues($db_record),                        'where'         => "`ref_sales_order_sent_id`='{$inventory_sales_order_sent_id}'",                    ));                    $passed = (!$result) ? false : $passed;                    $this->SQL->EchoQuery($this->Classname, __FUNCTION__);                                                                                # ===== COMMIT TRANSACTION ============================================================                    if ($passed) {                        $this->SQL->TransactionCommit();                                                // save the database transactions to database                        $return = 1;                    } else {                        $this->SQL->Rollback();                                                         // remove all the database transactions from the database                        $return = 0;                    }                                                                        } // end checking for 'inventory_sales_order_sent_id'            break;        }                echo $return;    }                public function ScriptUnsendInventory()    {        $CLASS_EXECUTE_LINK     = '/office/AJAX/class_execute';        $eq                     = EncryptQuery("class={$this->Classname}");                $script = <<<SCRIPT                    function tableUnsendInventoryClick(idx, value, eq)            {                var idbase = 'TABLE_ROW_ID' + idx + '_';                var rowNumber = $('#' + idbase + value + ' td:first-child').html().replace('.', '');                $('#' + idbase + value +' td').css('background-color','#ff7');                if (confirm('Are you sure you want to delete row (' + rowNumber + ')?')) {                    $.get('{$CLASS_EXECUTE_LINK}?eq={$eq}&action=delete_sent_inventory&id=' + value, '', function(data){                        if (data == 1) {                            location.reload();  // reload the page as many items need to be updated                            //$('#' + idbase + value +' td').fadeOut();                        } else {                            alert('Error: Could not delete record! :: ' + data);                        }                    });                }                $('#' + idbase + value +' td').css('background-color','');                return false;            }                SCRIPT;AddScript($script);    }        public function SetFormArrays()    {        // not using function because we won't edit these lines    }        public function GetTableHeading($colcount)    {        $export = ($this->Show_Export)? $this->GetExportBlock() : '';        $RESULT = '            <tr class="TABLE_TITLE">                <td colspan="'. $colcount. '">                ' . $export . '                    Previously Received Inventory                </td>            </tr>';        return $RESULT;    }        public function ProcessTableCell($field, &$value, &$td_options, $id='')    {        # ============ WHEN VIEWING A TABLE ============                parent::ProcessTableCell($field, $value, $td_options, $id);        switch ($field) {            default:                // ----- MODIFY THE OPTIONS IN THE MAIN TABLE DISPLAY -----                $CLASS_EXECUTE_LINK     = '/office/AJAX/class_execute';                $eq                     = EncryptQuery("class={$this->Classname};v1={$id}");                $link                   = $CLASS_EXECUTE_LINK . '?eq=' . $eq . "&action=delete_sent_inventory&id={$id}";                $script                 = "top.parent.appformCreate('Window', '{$link}', 'apps'); return false;";                                $this->Edit_Links = qqn("                    <td align=`center`><a href=`#` class=`row_delete`   title=`Delete` onclick=`tableUnsendInventoryClick('@IDX@','@VALUE@','@EQ@'); return false; `></a></td>                ");            break;                                    case "date":                $value = date('M d, Y', strtotime($value));            break;                        case "quantity":                $value = number_format($value);            break;                        case "price_total":            case "price_shipping":                $value = money_format('%n', $value);            break;        }    }        }  // -------------- END CLASS --------------